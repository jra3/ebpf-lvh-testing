name: Clean eBPF Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-bpf:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        kernel: ["5.10", "5.15", "6.1", "6.6"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y clang llvm bpftool libelf-dev libbpf-dev
    
    - name: Build eBPF programs
      run: |
        echo "=== Building eBPF programs ==="
        make -C src/bpf clean all
        ls -la src/bpf/*.o
    
    - name: Test BPF verification
      run: |
        echo "=== Testing BPF verification ==="
        # Test that our BPF programs pass kernel verification
        sudo bpftool prog load src/bpf/minimal.o /sys/fs/bpf/test_minimal
        
        # Show loaded program
        sudo bpftool prog show name minimal_prog
        
        # Clean up
        sudo rm -f /sys/fs/bpf/test_minimal
        
        echo "✅ BPF program passed verification on kernel $(uname -r)"
    
    - name: Install LVH for future VM testing
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Setup LVH
      run: |
        echo "=== Installing LVH ==="
        go install github.com/cilium/little-vm-helper/cmd/lvh@latest
        export PATH="$(go env GOPATH)/bin:$PATH"
        
        echo "=== Pulling kernel ${{ matrix.kernel }} ==="
        lvh kernels pull ${{ matrix.kernel }}-main || echo "Kernel ${{ matrix.kernel }} not available"
        
        echo "✅ LVH ready for local development"
        echo "To test with VMs locally, run:"
        echo "  1. Build image: lvh images build"
        echo "  2. Run VM: lvh run --image <image> --kernel <kernel>"
    
    - name: Summary
      run: |
        echo "=== Test Summary ==="
        echo "✅ eBPF programs compile successfully"
        echo "✅ eBPF programs pass kernel verification"
        echo "✅ Ready for testing on kernel ${{ matrix.kernel }}"
        echo ""
        echo "Note: Full VM-based testing requires building VM images locally"